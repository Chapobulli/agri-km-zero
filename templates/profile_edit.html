{% extends "base.html" %}
{% block content %}
<div class="container mt-4 mb-5">
    {% if farmer %}
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0"><i class="fas fa-store"></i> Modifica Pagina Azienda</h3>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="farmerForm">
                {{ form.hidden_tag() }}
                
                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-user"></i> Account</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.username.label(class="font-weight-bold") }}
                        {{ form.username(class="form-control") }}
                        <small class="form-text text-muted">Il tuo nome utente univoco per il login</small>
                    </div>
                    <div class="form-group mb-3">
                        {{ form.display_name.label(class="font-weight-bold") }}
                        {{ form.display_name(class="form-control", placeholder="Es: Mario Rossi") }}
                        <small class="form-text text-muted">Nome mostrato pubblicamente (opzionale)</small>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-info-circle"></i> Informazioni Azienda</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.company_name.label(class="font-weight-bold") }}
                        {{ form.company_name(class="form-control form-control-lg") }}
                    </div>
                    <div class="form-group mb-3">
                        {{ form.phone.label(class="font-weight-bold") }}
                        {{ form.phone(class="form-control", placeholder="Es: +393201234567") }}
                        <small class="form-text text-muted">Usato per contatto diretto e WhatsApp</small>
                    </div>
                    <div class="form-group mb-3">
                        {{ form.company_description.label(class="font-weight-bold") }}
                        {{ form.company_description(class="form-control", rows="4", placeholder="Descrivi la tua azienda agricola...") }}
                        <small class="form-text text-muted">Lascia vuoto per mantenere il valore attuale</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-map-marker-alt"></i> Localizzazione</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.province.label(class="font-weight-bold") }}
                                {{ form.province(class="form-control", id="province") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.city.label(class="font-weight-bold") }}
                                {{ form.city(class="form-control", id="city") }}
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        {{ form.address.label(class="font-weight-bold") }}
                        <div class="position-relative">
                            {{ form.address(class="form-control", id="addressInput", placeholder="Es: Via Roma, 10", autocomplete="off") }}
                            <div id="addressSuggestions" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></div>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-lightbulb"></i> Inizia a digitare l'indirizzo e seleziona dai suggerimenti
                        </small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-images"></i> Immagini</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.company_logo.label(class="font-weight-bold") }}
                                {{ form.company_logo(class="form-control-file") }}
                                <small class="form-text text-muted">Logo aziendale (consigliato: quadrato)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.company_cover.label(class="font-weight-bold") }}
                                {{ form.company_cover(class="form-control-file") }}
                                <small class="form-text text-muted">Immagine copertina (consigliato: 16:9)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-truck"></i> Servizi</h5>
                    <hr>
                    <div class="form-group form-check">
                        {{ form.delivery(class="form-check-input") }}
                        {{ form.delivery.label(class="form-check-label font-weight-bold") }}
                        <small class="form-text text-muted">Indica se offri servizio di consegna a domicilio</small>
                    </div>
                </div>

                <div class="text-right">
                    <a href="{% if current_user.is_farmer %}{{ url_for('profiles.view_company', slug=current_user.company_slug or current_user.compute_company_slug()) }}{% else %}{{ url_for('profiles.view_profile', username=current_user.username) }}{% endif %}" class="btn btn-secondary mr-2">
                        <i class="fas fa-times"></i> Annulla
                    </a>
                    {{ form.submit(class="btn btn-success btn-lg") }}
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fas fa-user"></i> Modifica Profilo</h3>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                
                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-info-circle"></i> Informazioni Personali</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.username.label(class="font-weight-bold") }}
                        {{ form.username(class="form-control form-control-lg") }}
                        <small class="form-text text-muted">Il tuo nome utente univoco per il login</small>
                    </div>
                    <div class="form-group mb-3">
                        {{ form.display_name.label(class="font-weight-bold") }}
                        {{ form.display_name(class="form-control", placeholder="Es: Mario Rossi") }}
                        <small class="form-text text-muted">Nome mostrato pubblicamente (opzionale)</small>
                    </div>
                    <div class="form-group mb-3">
                        {{ form.bio.label(class="font-weight-bold") }}
                        {{ form.bio(class="form-control", rows="3", placeholder="Racconta qualcosa di te...") }}
                        <small class="form-text text-muted">Lascia vuoto per mantenere il valore attuale</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-map-marker-alt"></i> Posizione</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.address.label(class="font-weight-bold") }}
                        {{ form.address(class="form-control", placeholder="Citt√† o zona approssimativa") }}
                        <small class="form-text text-muted">Lascia vuoto per mantenere il valore attuale</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-camera"></i> Foto Profilo</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.profile_photo.label(class="font-weight-bold") }}
                        {{ form.profile_photo(class="form-control-file") }}
                        <small class="form-text text-muted">Consigliato: foto quadrata</small>
                    </div>
                </div>

                <div class="text-right">
                    <a href="{{ url_for('profiles.view_profile', username=current_user.username) }}" class="btn btn-secondary mr-2">
                        <i class="fas fa-times"></i> Annulla
                    </a>
                    {{ form.submit(class="btn btn-primary btn-lg") }}
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Dynamic cities loading on province change
const provinceSelect = document.getElementById('province');
if (provinceSelect) {
    provinceSelect.addEventListener('change', async function() {
        const province = this.value;
        const citySelect = document.getElementById('city');
        
        if (!province) {
            citySelect.innerHTML = '<option value="">Seleziona prima la provincia</option>';
            return;
        }
        
        try {
            const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
            const cities = await res.json();
            
            citySelect.innerHTML = '<option value="">Seleziona Comune</option>';
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                citySelect.appendChild(opt);
            });
        } catch (e) {
            console.error('Error loading cities:', e);
            citySelect.innerHTML = '<option value="">Errore nel caricamento comuni</option>';
        }
    });
    
    // Trigger on page load if province is already selected
    if (provinceSelect.value) {
        const currentCity = document.getElementById('city').value;
        provinceSelect.dispatchEvent(new Event('change'));
        // Restore selected city after loading
        setTimeout(() => {
            if (currentCity) {
                document.getElementById('city').value = currentCity;
            }
        }, 100);
    }
}

// Address autocomplete with Nominatim
const addressInput = document.getElementById('addressInput');
if (addressInput) {
    let debounceTimer;
    const suggestionsDiv = document.getElementById('addressSuggestions');
    
    addressInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();
        
        if (query.length < 3) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        debounceTimer = setTimeout(async () => {
            const cityValue = document.getElementById('city')?.value;
            const provinceValue = document.getElementById('province')?.value;
            
            // Build search query with context
            let searchQuery = query;
            if (cityValue) searchQuery += `, ${cityValue}`;
            if (provinceValue) searchQuery += `, ${provinceValue}`;
            searchQuery += ', Sardegna, Italia';
            
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&addressdetails=1`;
                const res = await fetch(url, {
                    headers: { 
                        'Accept-Language': 'it',
                        'User-Agent': 'AgriKmZero/1.0'
                    }
                });
                const data = await res.json();
                
                if (data && data.length > 0) {
                    suggestionsDiv.innerHTML = '';
                    data.forEach(item => {
                        const address = item.address;
                        let displayText = '';
                        
                        // Format address intelligently
                        if (address.road) {
                            displayText = address.road;
                            if (address.house_number) {
                                displayText += ', ' + address.house_number;
                            }
                        } else {
                            displayText = item.display_name.split(',').slice(0, 2).join(',');
                        }
                        
                        const suggestionItem = document.createElement('a');
                        suggestionItem.href = '#';
                        suggestionItem.className = 'list-group-item list-group-item-action';
                        suggestionItem.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <small><i class="fas fa-map-marker-alt text-success"></i> ${displayText}</small>
                            </div>
                            <small class="text-muted">${address.city || address.town || address.village || ''}</small>
                        `;
                        
                        suggestionItem.addEventListener('click', function(e) {
                            e.preventDefault();
                            addressInput.value = displayText;
                            suggestionsDiv.style.display = 'none';
                        });
                        
                        suggestionsDiv.appendChild(suggestionItem);
                    });
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            } catch (e) {
                console.error('Error fetching address suggestions:', e);
                suggestionsDiv.style.display = 'none';
            }
        }, 500);
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== addressInput && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
