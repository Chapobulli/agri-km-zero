{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    {% if farmer %}
    <h2>Modifica Pagina Azienda</h2>
    <form method="POST" enctype="multipart/form-data" id="farmerForm">
        {{ form.hidden_tag() }}
        <div class="form-group">{{ form.company_name.label }} {{ form.company_name(class="form-control") }}</div>
        <div class="form-group">{{ form.company_description.label }} {{ form.company_description(class="form-control", placeholder="Lascia vuoto per mantenere il valore attuale") }}</div>
        <div class="form-row">
            <div class="form-group col-md-6">
                {{ form.province.label }} 
                {{ form.province(class="form-control", id="province", onchange="updateCities()") }}
            </div>
            <div class="form-group col-md-6">
                {{ form.city.label }} 
                {{ form.city(class="form-control", id="city") }}
            </div>
        </div>
        <div class="form-group">{{ form.address.label }} {{ form.address(class="form-control", placeholder="Indirizzo completo (via, numero)") }}</div>
        <div class="form-row">
            <div class="form-group col-md-6">{{ form.latitude.label }} {{ form.latitude(class="form-control") }}</div>
            <div class="form-group col-md-6">{{ form.longitude.label }} {{ form.longitude(class="form-control") }}</div>
        </div>
        <button type="button" class="btn btn-secondary btn-sm mb-3" onclick="geocodeAddress('farmer')"><i class="fas fa-map-marked-alt"></i> Geocodifica Indirizzo</button>
        <div class="form-row">
            <div class="form-group col-md-6">{{ form.company_logo.label }} {{ form.company_logo(class="form-control-file") }}</div>
            <div class="form-group col-md-6">{{ form.company_cover.label }} {{ form.company_cover(class="form-control-file") }}</div>
        </div>
        <div class="form-group form-check">{{ form.delivery() }} {{ form.delivery.label }}</div>
        {{ form.submit(class="btn btn-success") }}
    </form>
    {% else %}
    <h2>Modifica Profilo</h2>
    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div class="form-group">{{ form.username.label }} {{ form.username(class="form-control") }}</div>
        <div class="form-group">{{ form.bio.label }} {{ form.bio(class="form-control", placeholder="Lascia vuoto per mantenere il valore attuale") }}</div>
        <div class="form-group">{{ form.address.label }} {{ form.address(class="form-control", placeholder="Lascia vuoto per mantenere il valore attuale") }}</div>
        <div class="form-row">
            <div class="form-group col-md-6">{{ form.latitude.label }} {{ form.latitude(class="form-control") }}</div>
            <div class="form-group col-md-6">{{ form.longitude.label }} {{ form.longitude(class="form-control") }}</div>
        </div>
        <button type="button" class="btn btn-secondary btn-sm mb-3" onclick="geocodeAddress('client')"><i class="fas fa-map-marked-alt"></i> Geocodifica Indirizzo</button>
        <div class="form-group">{{ form.profile_photo.label }} {{ form.profile_photo(class="form-control-file") }}</div>
        {{ form.submit(class="btn btn-success") }}
    </form>
    {% endif %}
</div>
<script>
async function geocodeAddress(type) {
    let addressInput = document.querySelector(type === 'farmer' ? 'input[name=address]' : 'input[name=address]');
    let latInput = document.querySelector(type === 'farmer' ? 'input[name=latitude]' : 'input[name=latitude]');
    let lngInput = document.querySelector(type === 'farmer' ? 'input[name=longitude]' : 'input[name=longitude]');
    if (!addressInput || !addressInput.value) { alert('Inserisci un indirizzo.'); return; }
    try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressInput.value)}`;
        const res = await fetch(url, { headers: { 'Accept-Language': 'it' } });
        const data = await res.json();
        if (data && data.length > 0) {
            latInput.value = data[0].lat;
            lngInput.value = data[0].lon;
        } else {
            alert('Indirizzo non trovato. Prova a essere pi√π specifico.');
        }
    } catch (e) { alert('Errore nella geocodifica.'); }
}
}

// Dynamic cities loading
async function updateCities() {
    const province = document.getElementById('province').value;
    const citySelect = document.getElementById('city');
    if (!province) {
        citySelect.innerHTML = '<option value="">Seleziona prima la provincia</option>';
        return;
    }
    try {
        const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
        const cities = await res.json();
        citySelect.innerHTML = '<option value="">Seleziona Comune</option>';
        cities.forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.textContent = city;
            citySelect.appendChild(opt);
        });
    } catch (e) {
        console.error('Error loading cities:', e);
    }
}
</script>
{% endblock %}
