{% extends "base.html" %}
{% block content %}
<div class="container mt-4 mb-5">
    {% if farmer %}
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0"><i class="fas fa-store"></i> Modifica Pagina Azienda</h3>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="farmerForm">
                {{ form.hidden_tag() }}
                
                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-info-circle"></i> Informazioni Azienda</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.company_name.label(class="font-weight-bold") }}
                        {{ form.company_name(class="form-control form-control-lg") }}
                    </div>
                    <div class="form-group mb-3">
                        {{ form.company_description.label(class="font-weight-bold") }}
                        {{ form.company_description(class="form-control", rows="4", placeholder="Descrivi la tua azienda agricola...") }}
                        <small class="form-text text-muted">Lascia vuoto per mantenere il valore attuale</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-map-marker-alt"></i> Localizzazione</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.province.label(class="font-weight-bold") }}
                                {{ form.province(class="form-control", id="province") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.city.label(class="font-weight-bold") }}
                                {{ form.city(class="form-control", id="city") }}
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        {{ form.address.label(class="font-weight-bold") }}
                        {{ form.address(class="form-control", placeholder="Via, numero civico") }}
                        <small class="form-text text-muted">L'indirizzo completo aiuta i clienti a trovarti</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-images"></i> Immagini</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.company_logo.label(class="font-weight-bold") }}
                                {{ form.company_logo(class="form-control-file") }}
                                <small class="form-text text-muted">Logo aziendale (consigliato: quadrato)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                {{ form.company_cover.label(class="font-weight-bold") }}
                                {{ form.company_cover(class="form-control-file") }}
                                <small class="form-text text-muted">Immagine copertina (consigliato: 16:9)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-success"><i class="fas fa-truck"></i> Servizi</h5>
                    <hr>
                    <div class="form-group form-check">
                        {{ form.delivery(class="form-check-input") }}
                        {{ form.delivery.label(class="form-check-label font-weight-bold") }}
                        <small class="form-text text-muted">Indica se offri servizio di consegna a domicilio</small>
                    </div>
                </div>

                <div class="text-right">
                    <a href="{{ url_for('profiles.view_profile', username=current_user.username) }}" class="btn btn-secondary mr-2">
                        <i class="fas fa-times"></i> Annulla
                    </a>
                    {{ form.submit(class="btn btn-success btn-lg") }}
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0"><i class="fas fa-user"></i> Modifica Profilo</h3>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                
                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-info-circle"></i> Informazioni Personali</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.username.label(class="font-weight-bold") }}
                        {{ form.username(class="form-control form-control-lg") }}
                    </div>
                    <div class="form-group mb-3">
                        {{ form.bio.label(class="font-weight-bold") }}
                        {{ form.bio(class="form-control", rows="3", placeholder="Racconta qualcosa di te...") }}
                        <small class="form-text text-muted">Lascia vuoto per mantenere il valore attuale</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-map-marker-alt"></i> Posizione</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.address.label(class="font-weight-bold") }}
                        {{ form.address(class="form-control", placeholder="Citt√† o zona approssimativa") }}
                        <small class="form-text text-muted">Lascia vuoto per mantenere il valore attuale</small>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="text-primary"><i class="fas fa-camera"></i> Foto Profilo</h5>
                    <hr>
                    <div class="form-group mb-3">
                        {{ form.profile_photo.label(class="font-weight-bold") }}
                        {{ form.profile_photo(class="form-control-file") }}
                        <small class="form-text text-muted">Consigliato: foto quadrata</small>
                    </div>
                </div>

                <div class="text-right">
                    <a href="{{ url_for('profiles.view_profile', username=current_user.username) }}" class="btn btn-secondary mr-2">
                        <i class="fas fa-times"></i> Annulla
                    </a>
                    {{ form.submit(class="btn btn-primary btn-lg") }}
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Dynamic cities loading on province change
const provinceSelect = document.getElementById('province');
if (provinceSelect) {
    provinceSelect.addEventListener('change', async function() {
        const province = this.value;
        const citySelect = document.getElementById('city');
        
        if (!province) {
            citySelect.innerHTML = '<option value="">Seleziona prima la provincia</option>';
            return;
        }
        
        try {
            const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
            const cities = await res.json();
            
            citySelect.innerHTML = '<option value="">Seleziona Comune</option>';
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                citySelect.appendChild(opt);
            });
        } catch (e) {
            console.error('Error loading cities:', e);
            citySelect.innerHTML = '<option value="">Errore nel caricamento comuni</option>';
        }
    });
    
    // Trigger on page load if province is already selected
    if (provinceSelect.value) {
        const currentCity = document.getElementById('city').value;
        provinceSelect.dispatchEvent(new Event('change'));
        // Restore selected city after loading
        setTimeout(() => {
            if (currentCity) {
                document.getElementById('city').value = currentCity;
            }
        }, 100);
    }
}
</script>
{% endblock %}
