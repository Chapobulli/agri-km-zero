{% extends "base.html" %}

{% block content %}
<!-- Hero Section con focus sulla ricerca -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center justify-content-center text-center py-5">
            <div class="col-lg-10">
                <h1 class="fade-in-up mb-3">Prodotti Freschi a KM0 dalla Tua Zona</h1>
                <p class="lead fade-in-up mb-4">Acquista direttamente dagli agricoltori locali. <br>Niente intermediari, solo prodotti freschi e genuini.</p>
                
                <!-- Ricerca immediata in evidenza -->
                <div class="card shadow-lg fade-in-up mt-4 mb-4" style="background: rgba(255,255,255,0.95);">
                    <div class="card-body p-4">
                        <h4 class="mb-4"><i class="fas fa-search text-success"></i> Trova Prodotti nella Tua Zona</h4>
                        <form method="GET" action="/" id="locationFilter">
                            <div class="row justify-content-center">
                                <div class="col-md-4 mb-3">
                                    <select name="province" id="provinceSelect" class="form-control form-control-lg" onchange="updateCitiesFilter()">
                                        <option value="">Seleziona Provincia</option>
                                        {% for prov in provinces %}
                                        <option value="{{ prov }}" {% if prov == selected_province %}selected{% endif %}>{{ prov }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <select name="city" id="citySelect" class="form-control form-control-lg">
                                        <option value="">Seleziona Comune</option>
                                        {% for c in cities %}
                                        <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <button type="submit" class="btn btn-success btn-lg btn-block">
                                        <i class="fas fa-search"></i> Cerca Ora
                                    </button>
                                </div>
                            </div>
                        </form>
                        <small class="text-muted">Scopri {{ farmers|length if farmers else '0' }} agricoltori e {{ products_data|length if products_data else '0' }} prodotti disponibili</small>
                    </div>
                </div>
                
                {% if not current_user.is_authenticated %}
                <div class="fade-in-up">
                    <a class="btn btn-primary btn-lg btn-custom mr-2" href="{{ url_for('auth.register') }}">
                        <i class="fas fa-user-plus"></i> Registrati Gratis
                    </a>
                    <a class="btn btn-outline-light btn-lg btn-custom" href="{{ url_for('auth.login') }}">
                        <i class="fas fa-sign-in-alt"></i> Accedi
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Products Section - Risultati Ricerca -->
<section class="py-5 bg-white">
    <div class="container">
        {% if selected_province or selected_city %}
            <h2 class="mb-4"><i class="fas fa-shopping-basket text-success"></i> Prodotti Trovati
                {% if selected_city %}a {{ selected_city }}{% elif selected_province %}in provincia di {{ selected_province }}{% endif %}
            </h2>
        {% else %}
            <h2 class="mb-4"><i class="fas fa-shopping-basket text-success"></i> Prodotti Disponibili</h2>
        {% endif %}

        {% if products_data %}
        <div class="row">
            {% for item in products_data %}
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm hover-shadow">
                    {% if item.image_path %}
                    <img src="{{ item.image_path|url_or_local }}" class="card-img-top" alt="{{ item.name }}" style="height: 180px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                        <i class="fas fa-image fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title font-weight-bold text-success">{{ item.name }}</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h5 text-success font-weight-bold mb-0">{{ "%.2f"|format(item.price) }} €</span>
                            <span class="badge badge-secondary">{{ item.unit }}</span>
                        </div>
                        <div class="border-top pt-2 mt-auto">
                            {% if item.farmer_name %}
                            <small class="text-muted d-block">
                                <i class="fas fa-store"></i> 
                                <a href="{{ url_for('profiles.view_profile', username=item.farmer_username) }}" class="text-decoration-none">
                                    {{ item.farmer_name }}
                                </a>
                            </small>
                            {% endif %}
                            {% if item.farmer_city or item.farmer_province %}
                            <small class="text-muted d-block mb-2">
                                <i class="fas fa-map-marker-alt"></i> 
                                {% if item.farmer_city %}{{ item.farmer_city }}{% endif %}
                            </small>
                            {% endif %}
                            {% if current_user.is_authenticated %}
                                {% if current_user.id != item.user_id %}
                                <a href="{{ url_for('messages.conversation', user_id=item.user_id) }}" class="btn btn-success btn-sm btn-block mt-2">
                                    <i class="fas fa-envelope"></i> Contatta
                                </a>
                                {% endif %}
                            {% else %}
                            <a href="{{ url_for('auth.register') }}" class="btn btn-success btn-sm btn-block mt-2">
                                <i class="fas fa-envelope"></i> Contatta
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="text-center mt-4">
            <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-success btn-lg">
                <i class="fas fa-th"></i> Vedi Tutti i Prodotti
            </a>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Nessun prodotto trovato in questa zona</h4>
            <p class="text-muted">Prova a cercare in un'altra provincia o comune</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Farmers List Section -->
{% if farmers %}
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="mb-4"><i class="fas fa-tractor text-success"></i> Agricoltori nella Tua Zona ({{ farmers|length }})</h2>
        <div class="row">
            {% for farmer in farmers[:6] %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm hover-shadow">
                    {% if farmer.company_cover %}
                    <img src="{{ farmer.company_cover|url_or_local }}" alt="Cover" class="card-img-top" style="height: 120px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            {% if farmer.company_logo %}
                            <img src="{{ farmer.company_logo|url_or_local }}" alt="Logo" class="mr-3" style="height: 50px; width: 50px; object-fit: cover; border-radius: 50%;">
                            {% else %}
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px; font-size: 1.5rem; font-weight: bold;">
                                {{ farmer.company_name[0] if farmer.company_name else farmer.username[0] }}
                            </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-0 font-weight-bold">{{ farmer.company_name or farmer.username }}</h5>
                                {% if farmer.city %}
                                <small class="text-muted"><i class="fas fa-map-marker-alt"></i> {{ farmer.city }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if farmer.company_description %}
                        <p class="card-text small text-muted mb-3">{{ farmer.company_description[:80] }}{% if farmer.company_description|length > 80 %}...{% endif %}</p>
                        {% endif %}
                        {% if farmer.delivery %}
                        <span class="badge badge-success mb-2"><i class="fas fa-truck"></i> Consegna</span>
                        {% endif %}
                        <a href="{{ url_for('profiles.view_profile', username=farmer.username) }}" class="btn btn-success btn-sm btn-block mt-2">
                            <i class="fas fa-store"></i> Vedi Azienda
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if farmers|length > 6 %}
        <div class="text-center mt-4">
            <a href="{{ url_for('profiles.companies') }}" class="btn btn-outline-success btn-lg">
                <i class="fas fa-building"></i> Vedi Tutte le Aziende
            </a>
        </div>
        {% endif %}
    </div>
</section>
{% endif %}

<!-- Features Section -->
<section class="py-5 bg-white">
    <div class="container">
        <h2 class="text-center mb-5"><i class="fas fa-star text-success"></i> Perché Scegliere KM Zero?</h2>
        <div class="row">
            <div class="col-md-4 mb-4 text-center">
                <div class="mb-3">
                    <i class="fas fa-leaf text-success" style="font-size: 3rem;"></i>
                </div>
                <h5>100% Fresco e Locale</h5>
                <p class="text-muted">Prodotti raccolti e venduti direttamente dagli agricoltori della tua zona</p>
            </div>
            <div class="col-md-4 mb-4 text-center">
                <div class="mb-3">
                    <i class="fas fa-handshake text-success" style="font-size: 3rem;"></i>
                </div>
                <h5>Nessun Intermediario</h5>
                <p class="text-muted">Contatta direttamente gli agricoltori, prezzi giusti per tutti</p>
            </div>
            <div class="col-md-4 mb-4 text-center">
                <div class="mb-3">
                    <i class="fas fa-map-marked-alt text-success" style="font-size: 3rem;"></i>
                </div>
                <h5>Km Zero Garantito</h5>
                <p class="text-muted">Riduci l'impatto ambientale supportando l'agricoltura locale</p>
            </div>
        </div>
    </div>
</section>

<!-- How It Works Section -->
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center mb-5">Come Funziona</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <h4 class="card-title text-success"><i class="fas fa-seedling mr-2"></i>Sei un Agricoltore?</h4>
                        <ul class="list-unstyled mt-3">
                            <li class="mb-2"><i class="fas fa-check-circle text-success mr-2"></i>Registrati gratuitamente</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success mr-2"></i>Pubblica i tuoi prodotti con foto e prezzi</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success mr-2"></i>Ricevi richieste dai clienti della tua zona</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success mr-2"></i>Vendi direttamente senza commissioni</li>
                        </ul>
                        {% if not current_user.is_authenticated %}
                        <a class="btn btn-success btn-block mt-3" href="{{ url_for('auth.register') }}">
                            <i class="fas fa-user-plus"></i> Registrati come Agricoltore
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <h4 class="card-title text-primary"><i class="fas fa-shopping-basket mr-2"></i>Cerchi Prodotti Freschi?</h4>
                        <ul class="list-unstyled mt-3">
                            <li class="mb-2"><i class="fas fa-check-circle text-primary mr-2"></i>Cerca prodotti nella tua provincia</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-primary mr-2"></i>Scopri agricoltori vicini a te</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-primary mr-2"></i>Contatta direttamente i produttori</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-primary mr-2"></i>Acquista prodotti freschi e genuini</li>
                        </ul>
                        {% if not current_user.is_authenticated %}
                        <a class="btn btn-primary btn-block mt-3" href="{{ url_for('auth.register') }}">
                            <i class="fas fa-user-plus"></i> Registrati come Cliente
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CTA Section -->
{% if not current_user.is_authenticated %}
<section class="py-5 bg-success text-white text-center">
    <div class="container">
        <h2 class="mb-3">Inizia Subito a Scoprire Prodotti Locali</h2>
        <p class="lead mb-4">Unisciti a centinaia di agricoltori e clienti che hanno scelto il km zero</p>
        <a class="btn btn-light btn-lg mr-2" href="{{ url_for('auth.register') }}">
            <i class="fas fa-user-plus"></i> Registrati Gratuitamente
        </a>
        <a class="btn btn-outline-light btn-lg" href="{{ url_for('products.list_products') }}">
            <i class="fas fa-eye"></i> Esplora Prodotti
        </a>
    </div>
</section>
{% endif %}

<script>
// Dynamic city loading for filter
async function updateCitiesFilter() {
    const province = document.getElementById('provinceSelect').value;
    const citySelect = document.getElementById('citySelect');
    
    if (!province) {
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        return;
    }
    
    try {
        const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
        const cities = await res.json();
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        cities.forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.textContent = city;
            citySelect.appendChild(opt);
        });
    } catch (e) {
        console.error('Error loading cities:', e);
    }
}
</script>
{% endblock %}