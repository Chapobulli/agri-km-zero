{% extends "base.html" %}

{% block content %}
<!-- Hero Split Layout inspired by reference -->
<section class="hero-split">
    <div class="container-fluid p-0">
        <div class="row no-gutters">
            <div class="col-lg-7 hero-visual" style="background-image: url('/static/images/hero/hero.png');">
                <div class="hero-overlay">
                    <span class="badge badge-pill badge-light text-success mb-3">Filiera corta e sostenibile</span>
                    <h1 class="mb-3">Dal campo alla tavola</h1>
                    <p class="lead mb-4">Acquista prodotti freschi e locali direttamente dagli agricoltori vicino a te. Nessun intermediario, solo qualità.</p>
                    <form class="hero-filters" method="get" action="{{ url_for('main.index') }}">
                        <div class="form-row">
                            <div class="form-group col-md-5 mb-2">
                                <label class="small text-white-50 mb-1" for="provinceSelect">Provincia</label>
                                <select class="form-control form-control-lg" id="provinceSelect" name="province" onchange="updateCitiesFilter()">
                                    <option value="">Tutte le Province</option>
                                    {% for p in provinces %}
                                    <option value="{{ p }}" {% if p == selected_province %}selected{% endif %}>{{ p }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-md-5 mb-2">
                                <label class="small text-white-50 mb-1" for="citySelect">Comune</label>
                                <select class="form-control form-control-lg" id="citySelect" name="city">
                                    <option value="">Tutti i Comuni</option>
                                    {% for c in cities %}
                                    <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-md-2 mb-2 d-flex align-items-end">
                                <button class="btn btn-success btn-lg btn-block" type="submit">Cerca</button>
                            </div>
                        </div>
                    </form>
                    <div class="d-flex flex-wrap align-items-center mt-3 text-white-50">
                        <span class="mr-3"><i class="fas fa-map-marker-alt"></i> Prodotti locali</span>
                        <span class="mr-3"><i class="fas fa-leaf"></i> Stagionali</span>
                        <span><i class="fas fa-handshake"></i> Con filiera corta</span>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 hero-panel">
                <div class="hero-panel-inner">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Prodotti di stagione</h4>
                        <a class="text-success font-weight-bold" href="{{ url_for('products.list_products') }}">Vedi tutti</a>
                    </div>
                    {% if products_data %}
                    <div class="row">
                        {% for item in products_data[:4] %}
                        <div class="col-sm-6 mb-4">
                            <div class="card product-card h-100">
                                {% if item.image_path %}
                                <img src="{{ item.image_path|url_or_local }}" class="card-img-top" alt="{{ item.name }}">
                                {% else %}
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 160px;">
                                    <i class="fas fa-leaf fa-2x text-success"></i>
                                </div>
                                {% endif %}
                                <div class="card-body">
                                    <h6 class="card-title mb-1">{{ item.name }}</h6>
                                    <p class="product-price mb-2">{{ '%.2f'|format(item.price|float) }} €</p>
                                    <p class="small text-muted mb-3">{{ item.farmer_name }}{% if item.farmer_city %} · {{ item.farmer_city }}{% endif %}</p>
                                    <a href="{{ url_for('profiles.view_company', slug=item.farmer_slug) }}" class="btn btn-success btn-block btn-sm">Vai all'azienda</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">Nessun prodotto disponibile al momento.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map Section: farmers near you -->
<section class="py-4" style="background:#fff;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fas fa-map-marked-alt text-success"></i> Mappa degli agricoltori</h4>
            <small class="text-muted">Centro: Oristano se non selezionato</small>
        </div>
        <div id="farmersMap" style="height:380px;border-radius:8px;overflow:hidden;border:1px solid #eee;"></div>
    </div>
</section>

<!-- Products Grid -->
<section class="py-5" style="background-color: #f5efe3;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="section-title mb-0 text-left">Prodotti di Stagione in Evidenza</h2>
            <a class="text-success font-weight-bold" href="{{ url_for('products.list_products') }}">Vedi tutti</a>
        </div>
        {% if products_data %}
        <div class="row">
            {% for item in products_data[:8] %}
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="card product-card h-100">
                    {% if item.image_path %}
                    <img src="{{ item.image_path|url_or_local }}" class="card-img-top" alt="{{ item.name }}">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center">
                        <i class="fas fa-leaf fa-3x text-success"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ item.name }}</h5>
                        <p class="product-price">{{ '%.2f'|format(item.price|float) }} €</p>
                        <p class="small text-muted mb-2">{{ item.farmer_name }}{% if item.farmer_city %} · {{ item.farmer_city }}{% endif %}</p>
                        <a href="{{ url_for('profiles.view_company', slug=item.farmer_slug) }}" class="btn btn-success btn-block">Vai all'azienda</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <p class="mb-0">Nessun prodotto disponibile al momento. <a href="{{ url_for('auth.register') }}">Registrati</a> come agricoltore per iniziare a vendere!</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- La Nostra Filiera Section -->
<section class="py-5 bg-white">
    <div class="container">
        <h2 class="section-title mb-4">La nostra filiera</h2>
        <p class="text-center text-muted mb-5">Riduciamo le distanze tra chi produce e chi acquista: filiera corta, prezzi trasparenti e qualità controllata.</p>
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-seedling text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Prodotti genuini</h6>
                <p class="text-muted small">Solo agricoltori selezionati della tua zona</p>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-truck text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Consegna diretta</h6>
                <p class="text-muted small">Ritiro in azienda o consegna locale</p>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-hand-holding-usd text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Prezzi equi</h6>
                <p class="text-muted small">Nessun intermediario, valore al produttore</p>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-leaf text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Sostenibilità</h6>
                <p class="text-muted small">Meno km, meno sprechi, più fresco</p>
            </div>
        </div>
    </div>
</section>

<!-- Farmers List Section -->
{% if farmers %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="fas fa-tractor text-success"></i> Agricoltori nella tua zona ({{ farmers|length }})</h2>
            {% if farmers|length > 6 %}
            <a href="{{ url_for('profiles.companies') }}" class="text-success font-weight-bold">Vedi tutte le aziende</a>
            {% endif %}
        </div>
        <div class="row">
            {% for farmer in farmers[:6] %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm hover-shadow">
                    {% if farmer.company_cover %}
                    <img src="{{ farmer.company_cover|url_or_local }}" alt="Cover" class="card-img-top" style="height: 140px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            {% if farmer.company_logo %}
                            <img src="{{ farmer.company_logo|url_or_local }}" alt="Logo" class="mr-3" style="height: 50px; width: 50px; object-fit: cover; border-radius: 50%;">
                            {% else %}
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px; font-size: 1.5rem; font-weight: bold;">
                                {{ farmer.company_name[0] if farmer.company_name else farmer.username[0] }}
                            </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-0 font-weight-bold">{{ farmer.company_name or farmer.username }}</h5>
                                {% if farmer.city %}
                                <small class="text-muted"><i class="fas fa-map-marker-alt"></i> {{ farmer.city }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if farmer.company_description %}
                        <p class="card-text small text-muted mb-3">{{ farmer.company_description[:90] }}{% if farmer.company_description|length > 90 %}...{% endif %}</p>
                        {% endif %}
                        {% if farmer.delivery %}
                        <span class="badge badge-success mb-2"><i class="fas fa-truck"></i> Consegna</span>
                        {% endif %}
                        <a href="{{ url_for('profiles.view_company', slug=farmer.company_slug or farmer.compute_company_slug()) }}" class="btn btn-success btn-sm btn-block mt-2">
                            <i class="fas fa-store"></i> Vedi Azienda
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
{% if not current_user.is_authenticated %}
<section class="py-5 bg-success text-white text-center">
    <div class="container">
        <h2 class="mb-3">Scopri i prodotti locali vicino a te</h2>
        <p class="lead mb-4">Unisciti ad agricoltori e clienti che hanno scelto la filiera corta.</p>
        <a class="btn btn-light btn-lg mr-2" href="{{ url_for('auth.register') }}">
            <i class="fas fa-user-plus"></i> Registrati Gratuitamente
        </a>
        <a class="btn btn-outline-light btn-lg" href="{{ url_for('products.list_products') }}">
            <i class="fas fa-eye"></i> Esplora Prodotti
        </a>
    </div>
</section>
{% endif %}

<!-- Leaflet Assets -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Dynamic city loading for filter
async function updateCitiesFilter() {
    const province = document.getElementById('provinceSelect').value;
    const citySelect = document.getElementById('citySelect');
    
    if (!province) {
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        return;
    }
    
    try {
        const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
        const cities = await res.json();
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        cities.forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.textContent = city;
            citySelect.appendChild(opt);
        });
    } catch (e) {
        console.error('Error loading cities:', e);
    }
}

// Initialize map with Oristano default center if no farmer coords
document.addEventListener('DOMContentLoaded', function() {
    try {
        if (!window.L) {
            console.warn('Leaflet non caricato');
            return;
        }
        var el = document.getElementById('farmersMap');
        if (!el) {
            console.warn('Container mappa mancante');
            return;
        }
        var center = [{{ center_lat }}, {{ center_lng }}];
        var map = L.map('farmersMap').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        var farmers = [
            {% for f in farmers %}
            {lat: {{ f.latitude or 'null' }}, lng: {{ f.longitude or 'null' }}, name: '{{ (f.company_name or f.username)|e }}', slug: '{{ (f.company_slug or f.compute_company_slug())|e }}', city: '{{ (f.city or '')|e }}', province: '{{ (f.province or '')|e }}'},
            {% endfor %}
        ];
        function addMarker(f) {
            var m = L.marker([f.lat, f.lng]).addTo(map);
            var html = '<strong>' + f.name + '</strong><br>' + (f.city || '') + '<br>' +
                       '<a href="' + '{{ url_for('profiles.view_company', slug='__SLUG__') }}'.replace('__SLUG__', f.slug) + '">Vedi profilo</a>';
            m.bindPopup(html);
        }
        farmers.forEach(async function(f) {
            if (f.lat != null && f.lng != null) {
                addMarker(f);
            } else if (f.city) {
                try {
                    const q = encodeURIComponent((f.city + ' ' + (f.province||'') + ' Italia').trim());
                    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + q + '&limit=1');
                    const data = await res.json();
                    if (data && data[0]) {
                        f.lat = parseFloat(data[0].lat);
                        f.lng = parseFloat(data[0].lon);
                        addMarker(f);
                    }
                } catch(e) { /* ignore */ }
            }
        });
    } catch(e) {
        console.error('Map init error', e);
    }
});
</script>
{% endblock %}