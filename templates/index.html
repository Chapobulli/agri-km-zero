{% extends "base.html" %}

{% block content %}
<!-- Hero Section - Professional -->
<section class="hero-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 80px 0; position: relative; overflow: hidden;">
    <div class="hero-pattern" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.05; background-image: url('/static/images/hero/hero.png'); background-size: cover; background-position: center;"></div>
    <div class="container" style="position: relative; z-index: 2;">
        <div class="row align-items-center">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="badge badge-success mb-3" style="font-size: 0.875rem; padding: 0.5rem 1rem;"><i class="fas fa-leaf mr-1"></i> Filiera Corta e Sostenibile</div>
                <h1 class="display-4 font-weight-bold mb-3" style="color: #2c3e50; line-height: 1.2;">Il tuo contadino di fiducia è più vicino di quanto pensi</h1>
                <p class="lead mb-4" style="color: #6c757d; font-size: 1.25rem;">Scopri i prodotti freschi degli agricoltori della tua zona. Ordina, ritira o ricevi direttamente a casa.</p>
                <div class="d-flex flex-wrap gap-3 mb-4">
                    <a href="{{ url_for('products.list_products') }}" class="btn btn-success btn-lg mr-2" style="padding: 0.875rem 2rem; font-weight: 600;"><i class="fas fa-shopping-basket mr-2"></i>Scopri i Prodotti</a>
                    <a href="{{ url_for('profiles.companies') }}" class="btn btn-outline-success btn-lg" style="padding: 0.875rem 2rem; font-weight: 600;"><i class="fas fa-store mr-2"></i>Le Aziende</a>
                </div>
                <!-- Trust Badges -->
                <div class="d-flex flex-wrap align-items-center mt-4 text-muted" style="font-size: 0.875rem; gap: 1.5rem;">
                    <div><i class="fas fa-shield-alt text-success mr-2"></i><strong>Pagamenti Sicuri</strong></div>
                    <div><i class="fas fa-truck text-success mr-2"></i><strong>Consegna Rapida</strong></div>
                    <div><i class="fas fa-check-circle text-success mr-2"></i><strong>100% Locale</strong></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="hero-image-wrapper" style="position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
                    <img src="/static/images/hero/hero.png" alt="Prodotti locali OrtoVicino" class="img-fluid" style="width: 100%; height: auto; display: block;">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Section - Trust Building -->
<section class="py-4" style="background: #fff; border-bottom: 1px solid #e9ecef;">
    <div class="container">
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-3 mb-md-0">
                <div class="stat-item">
                    <h3 class="font-weight-bold text-success mb-1"><i class="fas fa-users"></i> 500+</h3>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">Clienti Soddisfatti</p>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3 mb-md-0">
                <div class="stat-item">
                    <h3 class="font-weight-bold text-success mb-1"><i class="fas fa-seedling"></i> 50+</h3>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">Agricoltori Partner</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <h3 class="font-weight-bold text-success mb-1"><i class="fas fa-shopping-basket"></i> 200+</h3>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">Prodotti Disponibili</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <h3 class="font-weight-bold text-success mb-1"><i class="fas fa-star"></i> 4.8/5</h3>
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">Valutazione Media</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Prodotti di stagione -->
<section class="py-5" style="background-color: #f5efe3;">
    <div class="container">
        <div class="text-center mb-4">
            <h2 class="section-title mb-2" style="font-size:2rem; font-weight:600; color:#2c3e50;">Prodotti di Stagione in Evidenza</h2>
            <p class="text-muted">Scopri i prodotti freschi e locali coltivati vicino a te</p>
        </div>
        {% if products_data %}
        <div class="row">
            {% for item in products_data[:8] %}
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="card product-card h-100 shadow-sm">
                    {% if item.image_path %}
                    <img src="{{ item.image_path|url_or_local }}" class="card-img-top" alt="{{ item.name }}" style="height:200px; object-fit:cover;">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="fas fa-leaf fa-3x text-success"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ item.name }}</h5>
                        <p class="product-price text-success font-weight-bold">{{ '%.2f'|format(item.price|float) }} €</p>
                        <p class="small text-muted mb-2"><i class="fas fa-store"></i> {{ item.farmer_name }}{% if item.farmer_city %} · {{ item.farmer_city }}{% endif %}</p>
                        <a href="{{ url_for('profiles.view_company', slug=item.farmer_slug) }}" class="btn btn-success btn-block btn-sm">Vai all'azienda</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="text-center mt-4">
            <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-success btn-lg">Vedi tutti i prodotti</a>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <p class="mb-0">Nessun prodotto disponibile al momento. <a href="{{ url_for('auth.register') }}">Registrati</a> come agricoltore per iniziare a vendere!</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Testimonials Section - Trust Building -->
<section class="py-5" style="background: linear-gradient(135deg, #6B8E23 0%, #4A7C59 100%);">
    <div class="container">
        <div class="text-center mb-5 text-white">
            <h2 class="font-weight-bold mb-3">Cosa Dicono i Nostri Clienti</h2>
            <p class="lead">Le recensioni di chi ha già scelto OrtoVicino</p>
        </div>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                        </div>
                        <p class="mb-3">"Finalmente posso acquistare verdure fresche direttamente dal contadino! La qualità è incomparabile e i prezzi sono molto convenienti."</p>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px; font-weight: 700;">MR</div>
                            <div class="text-left">
                                <h6 class="mb-0 font-weight-bold">Maria Rossi</h6>
                                <small class="text-muted">Cagliari</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                        </div>
                        <p class="mb-3">"Ottima piattaforma! Ho trovato agricoltori vicino a casa mia e ora compro sempre da loro. Prodotti freschi e km zero garantito."</p>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px; font-weight: 700;">GL</div>
                            <div class="text-left">
                                <h6 class="mb-0 font-weight-bold">Giovanni Lai</h6>
                                <small class="text-muted">Sassari</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                        </div>
                        <p class="mb-3">"Sono un'agricoltrice e grazie a OrtoVicino ho trovato nuovi clienti. Semplice da usare e mi aiuta a vendere i miei prodotti direttamente."</p>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px; font-weight: 700;">AP</div>
                            <div class="text-left">
                                <h6 class="mb-0 font-weight-bold">Anna Piras</h6>
                                <small class="text-muted">Oristano</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map Section: farmers near you -->
<section class="py-5" style="background:#fff;">
    <div class="container">
        <div class="text-center mb-4">
            <h4 class="mb-2"><i class="fas fa-map-marked-alt text-success"></i> Mappa degli Agricoltori</h4>
            <p class="text-muted">Trova gli agricoltori vicino a te</p>
        </div>
        <div id="farmersMap" style="height:400px;border-radius:8px;overflow:hidden;border:1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
    </div>
</section>

<!-- Perché Sceglierci Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="section-title">Perché Scegliere OrtoVicino?</h2>
            <p class="lead text-muted">I motivi per cui migliaia di persone scelgono OrtoVicino ogni giorno</p>
        </div>
        <div class="row text-center">
            <div class="col-md-4 mb-4">
                <div class="mb-3">
                    <i class="fas fa-euro-sign text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="font-weight-bold mb-3">Prezzi più Convenienti</h5>
                <p class="text-muted">Acquista direttamente dal produttore senza intermediari. Risparmia e sostieni l'economia locale.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="mb-3">
                    <i class="fas fa-apple-alt text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="font-weight-bold mb-3">Qualità e Freschezza</h5>
                <p class="text-muted">Prodotti freschi raccolti da agricoltori locali. Dalla terra alla tua tavola in pochi km.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="mb-3">
                    <i class="fas fa-leaf text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="font-weight-bold mb-3">Sostenibilità</h5>
                <p class="text-muted">Riduci l'impatto ambientale con la filiera corta. Meno trasporti, meno sprechi, più natura.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="mb-3">
                    <i class="fas fa-handshake text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="font-weight-bold mb-3">Trasparenza Totale</h5>
                <p class="text-muted">Conosci chi produce il tuo cibo. Tracciabilità completa e contatto diretto con l'agricoltore.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="mb-3">
                    <i class="fas fa-boxes text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="font-weight-bold mb-3">Varietà Esclusiva</h5>
                <p class="text-muted">Trova prodotti unici e di nicchia che non trovi al supermercato. Scopri varietà locali autentiche.</p>
            </div>
            <div class="col-md-4 mb-4">
                <div class="mb-3">
                    <i class="fas fa-heart text-success" style="font-size: 3rem;"></i>
                </div>
                <h5 class="font-weight-bold mb-3">Supporto Locale</h5>
                <p class="text-muted">Sostieni le piccole aziende agricole del territorio. Ogni acquisto aiuta famiglie locali.</p>
            </div>
        </div>
    </div>
</section>

<!-- La Nostra Filiera Section -->
<section class="py-5 bg-white">
    <div class="container">
        <h2 class="section-title mb-4">La nostra filiera</h2>
        <p class="text-center text-muted mb-5">Riduciamo le distanze tra chi produce e chi acquista: filiera corta, prezzi trasparenti e qualità controllata.</p>
        <div class="row text-center">
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-seedling text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Prodotti genuini</h6>
                <p class="text-muted small">Solo agricoltori selezionati della tua zona</p>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-truck text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Consegna diretta</h6>
                <p class="text-muted small">Ritiro in azienda o consegna locale</p>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-hand-holding-usd text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Prezzi equi</h6>
                <p class="text-muted small">Nessun intermediario, valore al produttore</p>
            </div>
            <div class="col-md-3 col-6 mb-4">
                <div class="mb-3">
                    <i class="fas fa-leaf text-success" style="font-size: 3rem;"></i>
                </div>
                <h6 class="font-weight-bold">Sostenibilità</h6>
                <p class="text-muted small">Meno km, meno sprechi, più fresco</p>
            </div>
        </div>
    </div>
</section>

<!-- Farmers List Section -->
{% if farmers %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0"><i class="fas fa-tractor text-success"></i> Agricoltori nella tua zona ({{ farmers|length }})</h2>
            {% if farmers|length > 6 %}
            <a href="{{ url_for('profiles.companies') }}" class="text-success font-weight-bold">Vedi tutte le aziende</a>
            {% endif %}
        </div>
        <div class="row">
            {% for farmer in farmers[:6] %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm hover-shadow">
                    {% if farmer.company_cover %}
                    <img src="{{ farmer.company_cover|url_or_local }}" alt="Cover" class="card-img-top" style="height: 140px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            {% if farmer.company_logo %}
                            <img src="{{ farmer.company_logo|url_or_local }}" alt="Logo" class="mr-3" style="height: 50px; width: 50px; object-fit: cover; border-radius: 50%;">
                            {% else %}
                            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center mr-3" style="width: 50px; height: 50px; font-size: 1.5rem; font-weight: bold;">
                                {{ farmer.company_name[0] if farmer.company_name else farmer.username[0] }}
                            </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-0 font-weight-bold">{{ farmer.company_name or farmer.username }}</h5>
                                {% if farmer.city %}
                                <small class="text-muted"><i class="fas fa-map-marker-alt"></i> {{ farmer.city }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if farmer.company_description %}
                        <p class="card-text small text-muted mb-3">{{ farmer.company_description[:90] }}{% if farmer.company_description|length > 90 %}...{% endif %}</p>
                        {% endif %}
                        {% if farmer.delivery %}
                        <span class="badge badge-success mb-2"><i class="fas fa-truck"></i> Consegna</span>
                        {% endif %}
                        <a href="{{ url_for('profiles.view_company', slug=farmer.company_slug or farmer.compute_company_slug()) }}" class="btn btn-success btn-sm btn-block mt-2">
                            <i class="fas fa-store"></i> Vedi Azienda
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
{% if not current_user.is_authenticated %}
<section class="py-5 bg-success text-white text-center">
    <div class="container">
        <h2 class="mb-3">Scopri i prodotti locali vicino a te</h2>
        <p class="lead mb-4">Unisciti ad agricoltori e clienti che hanno scelto la filiera corta.</p>
        <a class="btn btn-light btn-lg mr-2" href="{{ url_for('auth.register') }}">
            <i class="fas fa-user-plus"></i> Registrati Gratuitamente
        </a>
        <a class="btn btn-outline-light btn-lg" href="{{ url_for('products.list_products') }}">
            <i class="fas fa-eye"></i> Esplora Prodotti
        </a>
    </div>
</section>
{% endif %}

<!-- Leaflet Assets -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Dynamic city loading for filter
async function updateCitiesFilter() {
    const province = document.getElementById('provinceSelect').value;
    const citySelect = document.getElementById('citySelect');
    
    if (!province) {
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        return;
    }
    
    try {
        const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
        const cities = await res.json();
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        cities.forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.textContent = city;
            citySelect.appendChild(opt);
        });
    } catch (e) {
        console.error('Error loading cities:', e);
    }
}

// Initialize map with Oristano default center if no farmer coords
document.addEventListener('DOMContentLoaded', function() {
    try {
        if (!window.L) {
            console.warn('Leaflet non caricato');
            return;
        }
        var el = document.getElementById('farmersMap');
        if (!el) {
            console.warn('Container mappa mancante');
            return;
        }
        var center = [{{ center_lat|default(40.0) }}, {{ center_lng|default(9.0) }}];
        var map = L.map('farmersMap').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        
        // Farmers data from server
        var farmersData = {{ farmers_json|safe }};
        
        function addMarker(f) {
            var m = L.marker([f.lat, f.lng]).addTo(map);
            var html = '<strong>' + f.name + '</strong><br>' + (f.city || '') + '<br>' +
                       '<a href="/azienda/' + f.slug + '">Vedi profilo</a>';
            m.bindPopup(html);
        }
        farmersData.forEach(async function(f) {
            if (f.lat != null && f.lng != null) {
                addMarker(f);
            } else if (f.city) {
                try {
                    const q = encodeURIComponent((f.city + ' ' + (f.province||'') + ' Italia').trim());
                    const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + q + '&limit=1');
                    const data = await res.json();
                    if (data && data[0]) {
                        f.lat = parseFloat(data[0].lat);
                        f.lng = parseFloat(data[0].lon);
                        addMarker(f);
                    }
                } catch(e) { /* ignore */ }
            }
        });
    } catch(e) {
        console.error('Map init error', e);
    }
});
</script>
{% endblock %}