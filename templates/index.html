{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center min-vh-80">
            <div class="col-lg-5">
                <h1 class="fade-in-up">Benvenuto in Agri KM Zero</h1>
                <p class="fade-in-up">Connetti agricoltori locali e clienti per prodotti freschi a km0. Acquista direttamente dagli agricoltori vicini, senza intermediari!</p>
                {% if not current_user.is_authenticated %}
                    <a class="btn btn-light btn-custom fade-in-up" href="{{ url_for('auth.register') }}">Iscriviti Ora</a>
                    <a class="btn btn-outline-light btn-custom ml-2 fade-in-up" href="{{ url_for('auth.login') }}">Accedi</a>
                {% endif %}
            </div>
            <div class="col-lg-7">
                <img src="/static/images/hero/hero.png" alt="Fresh Local Products" class="hero-image-large fade-in-up" onerror="this.src='https://via.placeholder.com/600x400/4CAF50/ffffff?text=Aggiungi+immagine+hero.png'">
            </div>
        </div>
    </div>
</section>

<!-- Location Filter Section -->
<section class="py-4 bg-white">
    <div class="container">
        <h3 class="text-center mb-4"><i class="fas fa-map-marker-alt text-success"></i> Trova Agricoltori e Prodotti nella Tua Zona</h3>
        <form method="GET" action="/" id="locationFilter">
            <div class="row justify-content-center">
                <div class="col-md-4 mb-3">
                    <select name="province" id="provinceSelect" class="form-control" onchange="updateCitiesFilter()">
                        <option value="">Tutte le Province</option>
                        {% for prov in provinces %}
                        <option value="{{ prov }}" {% if prov == selected_province %}selected{% endif %}>{{ prov }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <select name="city" id="citySelect" class="form-control">
                        <option value="">Tutti i Comuni</option>
                        {% for c in cities %}
                        <option value="{{ c }}" {% if c == selected_city %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <button type="submit" class="btn btn-success btn-block"><i class="fas fa-search"></i> Cerca</button>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Farmers List Section -->
{% if farmers %}
<section class="py-4 bg-light">
    <div class="container">
        <h3 class="mb-4"><i class="fas fa-users text-success"></i> Agricoltori Disponibili ({{ farmers|length }})</h3>
        <div class="row">
            {% for farmer in farmers %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 shadow-sm">
                    {% if farmer.company_logo %}
                    <div class="text-center pt-3">
                        <img src="{{ farmer.company_logo|url_or_local }}" alt="Logo" style="height: 60px; width: 60px; object-fit: cover; border-radius: 50%;">
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title font-weight-bold">{{ farmer.company_name or farmer.username }}</h5>
                        {% if farmer.city or farmer.province %}
                        <p class="text-muted small mb-2">
                            <i class="fas fa-map-marker-alt text-success"></i> 
                            {% if farmer.city %}{{ farmer.city }}{% endif %}{% if farmer.city and farmer.province %}, {% endif %}{% if farmer.province %}{{ farmer.province }}{% endif %}
                        </p>
                        {% endif %}
                        {% if farmer.address and farmer.city and farmer.province %}
                        <p class="small mb-2">
                            <a href="https://www.google.com/maps/search/?api=1&query={{ farmer.address|urlencode }},{{ farmer.city|urlencode }},{{ farmer.province|urlencode }}" target="_blank" class="text-success text-decoration-none">
                                <i class="fas fa-directions"></i> {{ farmer.address }}
                            </a>
                        </p>
                        {% endif %}
                        {% if farmer.company_description %}
                        <p class="card-text small text-muted" style="min-height: 40px;">{{ farmer.company_description[:100] }}{% if farmer.company_description|length > 100 %}...{% endif %}</p>
                        {% endif %}
                        <div class="mt-3">
                            {% if farmer.delivery %}
                            <span class="badge badge-success mb-2"><i class="fas fa-truck"></i> Consegna disponibile</span>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('profiles.view_profile', username=farmer.username) }}" class="btn btn-success btn-sm btn-block mt-2">
                            <i class="fas fa-store"></i> Vedi Pagina Azienda
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Products Section -->
<section class="py-5 bg-light nearby-products">
    <div class="container">
        <h2 class="section-title fade-in-up">Prodotti Disponibili</h2>
        <p class="text-center mb-4 fade-in-up">Prodotti freschi a km0 dagli agricoltori locali</p>

        {% if products_data %}
        <div class="row">
            {% for item in products_data %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 fade-in-up">
                    {% if item.image_path %}
                    <img src="{{ item.image_path|url_or_local }}" class="card-img-top" alt="{{ item.name }}" style="height: 200px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="fas fa-image fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h6 class="card-title text-success font-weight-bold">{{ item.name }}</h6>
                        <p class="card-text text-muted small" style="min-height: 40px;">{{ item.description[:60] if item.description else 'Nessuna descrizione' }}{% if item.description and item.description|length > 60 %}...{% endif %}</p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-success font-weight-bold h5 mb-0">{{ "%.2f"|format(item.price) }} €</span>
                            <span class="badge badge-secondary">{{ item.unit }}</span>
                        </div>
                        {% if item.farmer_name %}
                        <small class="text-muted d-block">
                            <i class="fas fa-store"></i> 
                            <a href="{{ url_for('profiles.view_profile', username=item.farmer_username) }}" class="text-decoration-none">
                                {{ item.farmer_name }}
                            </a>
                        </small>
                        {% endif %}
                        {% if item.farmer_city or item.farmer_province %}
                        <small class="text-muted d-block mb-2">
                            <i class="fas fa-map-marker-alt"></i> 
                            {% if item.farmer_city %}{{ item.farmer_city }}{% endif %}{% if item.farmer_city and item.farmer_province %}, {% endif %}{% if item.farmer_province %}{{ item.farmer_province }}{% endif %}
                        </small>
                        {% endif %}
                        {% if current_user.is_authenticated %}
                            {% if current_user.id != item.user_id %}
                            <a href="{{ url_for('messages.send_message', user_id=item.user_id) }}" class="btn btn-success btn-sm btn-block mt-2">
                                <i class="fas fa-envelope"></i> Contatta
                            </a>
                            {% endif %}
                        {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-outline-success btn-sm btn-block mt-2">
                            <i class="fas fa-sign-in-alt"></i> Accedi per Contattare
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-seedling text-success" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Nessun prodotto disponibile al momento</h4>
            <p class="text-muted">Torna presto per scoprire nuovi prodotti locali!</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Features Section -->
<section class="py-5">
    <div class="container">
        <h2 class="section-title fade-in-up">Perché Scegliere Agri KM Zero?</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-body text-center">
                        <i class="fas fa-leaf feature-icon"></i>
                        <h5 class="card-title">Prodotti Freschi</h5>
                        <p class="card-text">Direttamente dagli agricoltori locali, garantendo freschezza e qualità massima.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-body text-center">
                        <i class="fas fa-globe-americas feature-icon"></i>
                        <h5 class="card-title">Sostenibilità</h5>
                        <p class="card-text">Riduci l'impatto ambientale acquistando prodotti a km0 e sostenendo l'agricoltura locale.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-body text-center">
                        <i class="fas fa-handshake feature-icon"></i>
                        <h5 class="card-title">Connessione Diretta</h5>
                        <p class="card-text">Interagisci direttamente con gli agricoltori senza intermediari, costruendo relazioni di fiducia.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Testimonials Section -->
<section class="py-5">
    <div class="container">
        <h2 class="section-title fade-in-up">Cosa Dicono i Nostri Utenti</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="testimonial fade-in-up">
                    <p>"Ho trovato agricoltori fantastici vicino a casa mia. I prodotti sono sempre freschissimi!"</p>
                    <footer class="blockquote-footer">Maria R., Cliente</footer>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="testimonial fade-in-up">
                    <p>"Come agricoltore, finalmente posso vendere direttamente ai clienti locali senza intermediari."</p>
                    <footer class="blockquote-footer">Giuseppe V., Agricoltore</footer>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="testimonial fade-in-up">
                    <p>"La piattaforma è facile da usare e mi aiuta a sostenere l'agricoltura sostenibile."</p>
                    <footer class="blockquote-footer">Anna L., Cliente</footer>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- How It Works Section -->
<section class="bg-light py-5">
    <div class="container">
        <h2 class="section-title fade-in-up">Come Funziona</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-user-friends text-success mr-2"></i>Per gli Agricoltori</h5>
                        <p class="card-text">Pubblica i tuoi prodotti agricoli freschi e connetti con clienti locali interessati ad acquisti diretti.</p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success mr-2"></i>Vendi gli ortaggi che hai prodotto</li>
                            <li><i class="fas fa-check text-success mr-2"></i>Ricevi messaggi dai clienti per visite in azienda</li>
                            <li><i class="fas fa-check text-success mr-2"></i>Promuovi la tua fattoria e prodotti sostenibili</li>
                        </ul>
                        {% if not current_user.is_authenticated %}
                            <a class="btn btn-success btn-custom" href="{{ url_for('auth.register') }}">Registrati come Agricoltore</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100 fade-in-up">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-shopping-cart text-primary mr-2"></i>Per i Clienti</h5>
                        <p class="card-text">Scopri agricoltori vicini e acquista prodotti freschi a km0.</p>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-primary mr-2"></i>Cerca prodotti locali nella tua zona</li>
                            <li><i class="fas fa-check text-primary mr-2"></i>Messaggia gli agricoltori per dettagli</li>
                            <li><i class="fas fa-check text-primary mr-2"></i>Sostieni l'agricoltura locale sostenibile</li>
                        </ul>
                        {% if not current_user.is_authenticated %}
                            <a class="btn btn-primary btn-custom" href="{{ url_for('auth.register') }}">Registrati come Cliente</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Guarantees Section -->
<section class="guaranties">
    <div class="container">
        <h2 class="section-title fade-in-up">Le Nostre Garanzie</h2>
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="guaranty-item fade-in-up">
                    <i class="fas fa-shield-alt"></i>
                    <h5>Sicurezza</h5>
                    <p>Piattaforma sicura per transazioni affidabili</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="guaranty-item fade-in-up">
                    <i class="fas fa-truck"></i>
                    <h5>Consegna</h5>
                    <p>Opzioni flessibili di ritiro e consegna</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="guaranty-item fade-in-up">
                    <i class="fas fa-award"></i>
                    <h5>Qualità</h5>
                    <p>Prodotti verificati e di alta qualità</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="guaranty-item fade-in-up">
                    <i class="fas fa-users"></i>
                    <h5>Supporto</h5>
                    <p>Assistenza clienti dedicata</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CTA Section -->
<section class="cta-section">
    <div class="container">
        <h2 class="fade-in-up">Pronto a Iniziare?</h2>
        <p class="fade-in-up">Unisciti alla comunità di Agri KM Zero e scopri il piacere dei prodotti locali freschi.</p>
        {% if not current_user.is_authenticated %}
            <a class="btn btn-light btn-custom fade-in-up" href="{{ url_for('auth.register') }}">Iscriviti Gratuitamente</a>
        {% else %}
            <a class="btn btn-light btn-custom fade-in-up" href="{{ url_for('products.list_products') }}">Esplora Prodotti</a>
        {% endif %}
    </div>
</section>

<script>
// Dynamic city loading for filter
async function updateCitiesFilter() {
    const province = document.getElementById('provinceSelect').value;
    const citySelect = document.getElementById('citySelect');
    
    if (!province) {
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        return;
    }
    
    try {
        const res = await fetch(`/api/cities?province=${encodeURIComponent(province)}`);
        const cities = await res.json();
        citySelect.innerHTML = '<option value="">Tutti i Comuni</option>';
        cities.forEach(city => {
            const opt = document.createElement('option');
            opt.value = city;
            opt.textContent = city;
            citySelect.appendChild(opt);
        });
    } catch (e) {
        console.error('Error loading cities:', e);
    }
}
</script>
{% endblock %}